<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:display="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <title>Chat</title>
    <link rel="stylesheet" type="text/css" href="resource/static/chat_style.css"/>
</head>
<body>

    <script language="JavaScript" th:inline="javascript">
        var ws = null;
        var MessageTypes = {};

        MessageTypes.JOIN = 1;
        MessageTypes.CHAT = 2;
        MessageTypes.GETUSERS = 3;
        MessageTypes.USERLIST = 4;
        MessageTypes.GETMESSAGES = 5;
        MessageTypes.MESSAGELIST = 6;
        MessageTypes.QUIT = 7;
        /* next comments is thymeleaf feature. Do not remove!*/
        /*<![CDATA[*/
        var me = [[${user.fullName}]];
        /*]]>*/
        var users_in_list = [];

        function connect() {
            ws = new WebSocket("ws://localhost:8080/ws-chat");
            ws.onopen = onOpen;
            ws.onclose = onClose;
            ws.onerror = onError;
            ws.onmessage = onMessage;
        }

        function onOpen() {
            console.log(getTime() + "Info: WebSocket connection opened.");
            var message = new JoinMessage(me);
            ws.send(JSON.stringify(message));
        }

        function JoinMessage(name) {
            this.type = MessageTypes.JOIN;
            this.name = name;
        }

        function onClose() {
            console.log(getTime() + "Info: WebSocket closed.");
        }

        function onMessage(message) {
            console.log(getTime() + "Message detected: " + message.data );
            var data = JSON.parse(message.data);
            processMessage(data);
        }

        function processMessage(message) {
            var user;
            var text;
            if (message.type === MessageTypes.JOIN ) {
                user = message.name;
                text = getTime() + user + " has join the chat.";
                printMessage(text);
            }

            if (message.type === MessageTypes.QUIT) {
                user = message.name;
                text = getTime() + user + " has leave the chat.";
                printMessage(text);
            }

            if (message.type === MessageTypes.CHAT) {
                text = message.message;
                printMessage(text);
            }

            if (message.type === MessageTypes.USERLIST) {
                users_in_list = message.users;
                //console.log(users);

                for (var x in message.users) {
                    console.log(message.users[x]);
                    user = message.users[x];
                    populateUserList(user)
                }

            }

        }

        function populateUserList(user) {
            var button = document.createElement("button");
            button.type = button;
            //button.value = user;
            button.innerHTML = user;
            button.onclick = setMessageTarget;
/*            button.style.position = "absolute";
            button.style.top = "0";
            button.style.left = "0";*/
            button.style.width = "100%";
            document.getElementById("wrapper").appendChild(button);
            console.log("populate " + user);
        }

/*        function UserListMessage(users) {
            this.type = MessageTypes.USERLIST;
            this.users = users;
        }*/

        function printMessage(text) {
            var textArea = document.getElementById("textarea");
            textArea.value = textArea.value + text + "\n";
        }

        function getTime() {
            var date = new Date();
            var hour = date.getHours();
            var min = date.getMinutes();
            var sec = date.getSeconds();
            var time = "" + convertTimeUnit(hour) + ":" + convertTimeUnit(min) + ":" + convertTimeUnit(sec) + ": ";
            return time;
        }

        function convertTimeUnit(unit) {
            if (unit.toString().length === 1) return "0" + unit.toString();
            return unit;
        }

        function onError(error) {
            console.log('Error detected.');
        }

        function setMessageTarget(userButton) {
/*          next comments is thymeleaf feature. Do not remove!*/
            /*<![CDATA[*/
            var target = [[${user.fullName}]];
            /*]]>*/
            document.getElementById("message_text").value = target + ", ";
        }

        function sendMessageByEnter(event) {
            var messageTextField = document.getElementById("message_text");
            var message = messageTextField.value;
            if (event.keyCode === 13) {
                if (message.length > 0) sendMessage(event);
            }
        }

        function sendMessage() {
            var messageTextField = document.getElementById("message_text");
            var text = messageTextField.value;
            messageTextField.value = "";
            if (text === "") return;

            var message = new ChatMessage(me, text);
            ws.send(JSON.stringify(message));
        }

        function ChatMessage(name, text) {
            this.type = MessageTypes.CHAT;
            this.author = name;
            this.message = text;
        }

        window.addEventListener("load", connect, false);
/*        Window.onload = function () {
            connect();
            //ws.send("Welcome from client!");
        }*/
    </script>
    <h1>Awesome Chat</h1>
    <!--css not works for now, have no idea why. Will solve it later-->
    <div style="position: relative; display: inline-block">
        <span>
            <div style="position: relative; display: inline-block">
                <textarea id="textarea" cols="70" rows="20" readonly="readonly" ></textarea>
            </div>
            <div id="users_area" style="position: relative; display: inline-block">
                <textarea id="userlist" cols="20" rows="20" readonly="readonly"></textarea>
                <!--Next comment is intellij idea's + thymeleaf bug workaround. Do not remove!-->
                <!--/*@thymesVar id="user" type="com.github.awesomechat.chat.models.User"*/-->
<!--                <button id="George@R"
                        style="position: absolute; top: 0; left: 0; width: 100%; text-align: left; outline: none;
                        border: none"
                        data-username="George Raspupkin"
                        onclick="setMessageTarget(this);" th:text="${user.fullName}">George R.</button>-->
                <div id="wrapper"
                     style="position: absolute; top: 0; left: 0; width: 100%; text-align: left; outline: none;
                     border: none">

                </div>
            </div>
        </span>
    </div>

    <div>
        Your message: <input id="message_text" type="text" size="71" maxlength="71" onkeyup="sendMessageByEnter(event);"/>
        <input type="submit" value="Send!" onclick="sendMessage();"/>
    </div>
    <br/><br/><br/>

</body>
</html>